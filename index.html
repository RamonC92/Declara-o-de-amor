<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de DÃ­vidas para o casamento</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{--bg:#fff6f8;--card:#ffffff;--accent:#b047e1;--muted:#7b6f72;--accent-2:#f7d6e0}
  body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background:linear-gradient(180deg,var(--bg),#fff);margin:0;padding:22px;color:#2b2b2b}
  .card{background:var(--card);padding:18px;border-radius:14px;box-shadow:0 8px 24px rgba(16,24,40,0.06);max-width:1200px;margin:0 auto;border-top:6px solid var(--accent-2);position:relative}
  h1{font-family: 'Georgia', serif;font-size:22px;margin:0 0 12px;color:var(--accent)}
  .title-deco{display:flex;align-items:center;gap:10px}
  .heart{font-size:20px;color:var(--accent)}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #f1e7eb;padding:10px;text-align:left;font-size:14px;vertical-align:middle}
  input[type="text"], input[type="date"], select{width:100%;box-sizing:border-box;padding:8px;border-radius:6px;border:1px solid #efe0e6}
  input[type="text"].wide{width:400px}
  button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(224,86,138,0.12)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
  .muted{color:var(--muted)}
  .totals{display:flex;gap:12px;align-items:center;justify-content:flex-end;margin-top:12px}
  .totals div{background:linear-gradient(90deg,#fff,#fff);padding:10px;border-radius:10px;border:1px dashed #f2dbe2}
  .card:before, .card:after{content:'';position:absolute;width:120px;height:120px;background-repeat:no-repeat;opacity:0.12}
  .card:before{left:-10px;top:-10px;background-image:radial-gradient(circle at 20% 20%, #f9e6ec 10%, transparent 11%), radial-gradient(circle at 80% 80%, #fdeef4 10%, transparent 11%)}
  .card:after{right:-10px;bottom:-10px;background-image:radial-gradient(circle at 30% 30%, #f9e6ec 10%, transparent 11%), radial-gradient(circle at 70% 70%, #fdeef4 10%, transparent 11%)}
  @media (max-width:900px){ input[type="text"].wide{width:100%} table{font-size:13px} }
</style>
</head>
<body>
  <div class="card">
    <div class="title-deco">
      <div class="heart">ðŸ’–</div>
      <h1>Controle de DÃ­vidas para o casamento</h1>
    </div>

    <div style="text-align:right;margin-top:6px;margin-bottom:6px">
      <label style="margin-right:8px;color:var(--muted)">Valor Obtido Total (R$):</label>
      <input id="globalObtained" type="text" step="0.01" style="width:160px;display:inline-block">
    </div>

    <div class="controls">
      <button id="add">+ Adicionar item</button>
      <button id="clear" class="ghost">Limpar</button>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <label class="muted">Filtrar atÃ©:</label>
        <input id="filterEnd" type="date">
        <button id="applyFilter" class="ghost">Aplicar</button>
        <button id="clearFilter" class="ghost">Limpar filtro</button>
      </div>
    </div>

    <table id="sheet">
      <thead>
        <tr>
          <th>Item (descriÃ§Ã£o)</th>
          <th style="width:140px">Valor total (R$)</th>
          <th>Parcelado?</th>
          <th style="width:120px">Qtd Parcelas</th>
          <th style="width:140px">Valor Parcela (R$)</th>
          <th style="width:120px">InÃ­cio</th>
          <th style="width:120px">Fim</th>
          <th style="width:140px">Restante (R$)</th>
          <th class="muted">Status</th>
          <th style="width:80px">AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td class="muted">Totais</td>
          <td style="text-align:right;font-weight:600" id="totalAll">R$ 0,00</td>
          <td></td>
          <td></td>
          <td style="text-align:right;font-weight:600" id="totalParcels">R$ 0,00</td>
          <td colspan="2" class="muted right" id="infoFilter">(sem filtro)</td>
          <td style="text-align:right;font-weight:600" id="totalRemaining">R$ 0,00</td>
          <td style="text-align:right" id="totalStatusCell"></td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <div style="margin-top:12px;color:var(--muted);font-size:13px">ExplicaÃ§Ã£o: o campo "Valor Obtido Total" (canto superior direito) subtrai do total geral. Parcelas sÃ³ contam se o vencimento estiver dentro do perÃ­odo filtrado.</div>
  </div>

<script>
  const tbody = document.querySelector('#sheet tbody')
  const addBtn = document.getElementById('add')
  const clearBtn = document.getElementById('clear')
  const filterEnd = document.getElementById('filterEnd')
  const applyFilterBtn = document.getElementById('applyFilter')
  const clearFilterBtn = document.getElementById('clearFilter')
  const totalAllEl = document.getElementById('totalAll')
  const totalParcelsEl = document.getElementById('totalParcels')
  const totalRemainingEl = document.getElementById('totalRemaining')
  const infoFilterEl = document.getElementById('infoFilter')

  let rows = [ {item:'Ex: Geladeira grande (descriÃ§Ã£o ampla)', amount:'', parcelado:false, qtd:1, parcelValue:'', start:'', end:''} ]
  let filterDate = null

  function render(){
    tbody.innerHTML = ''
    rows.forEach((r,i)=>{
      const tr = document.createElement('tr')
      tr.innerHTML = `
        <td><input type="text" class="wide" value="${escapeHtml(r.item||'')}" data-col="item" data-i="${i}"></td>
        <td style="text-align:right; min-width:150px; white-space:nowrap"><input type="text" value="${r.amount||''}" data-col="amount" data-i="${i}"></td>
        <td style="text-align:center"><select data-col="parcelado" data-i="${i}"><option value="false" ${!r.parcelado?'selected':''}>NÃ£o</option><option value="true" ${r.parcelado?'selected':''}>Sim</option></select></td>
        <td><input type="text" value="${r.qtd||1}" data-col="qtd" data-i="${i}"></td>
        <td style="text-align:right; min-width:150px; white-space:nowrap"><input type="text" value="${r.parcelValue||''}" data-col="parcelValue" data-i="${i}" readonly></td>
        <td><input type="date" value="${r.start||''}" data-col="start" data-i="${i}"></td>
        <td><input type="date" value="${r.end||''}" data-col="end" data-i="${i}"></td>
        <td style="text-align:right;font-weight:600" data-remaining data-i="${i}">R$ 0,00</td>
        <td class="muted" data-status data-i="${i}"></td>
        <td><button data-action="del" data-i="${i}" class="ghost">ðŸ—‘</button></td>
      `
      tbody.appendChild(tr)
    })
    attachListeners()
    updateTotals()
  }

  function escapeHtml(text){ return (text||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') }

  function attachListeners(){
    // âš¡ MudanÃ§a importante: onblur permite digitar valores longos
    tbody.querySelectorAll('input, select').forEach(inp=> inp.onblur = onEdit)
    tbody.querySelectorAll('button[data-action="del"]').forEach(btn=> btn.onclick = ()=>{ rows.splice(Number(btn.dataset.i),1); render() })
  }

  function onEdit(e){
    const el = e.target
    const i = Number(el.dataset.i)
    const col = el.dataset.col
    let val = el.value
    if(col === 'parcelado') val = (val === 'true')
    rows[i][col] = val
    // auto-calcula valor da parcela
    const total = parseFloat((rows[i].amount||'').toString().replace(',','.')) || 0
    const qtd = parseInt(rows[i].qtd) || 0
    rows[i].parcelValue = (qtd>0) ? (total / qtd).toFixed(2) : ''
    render()
  }

  function parseDate(s){ if(!s) return null; const d = new Date(s + 'T00:00:00'); return isNaN(d) ? null : d }
  function addMonths(date, n){ const d = new Date(date); d.setMonth(d.getMonth()+n); return d }

  function computeRowParcelInfo(row, upToDate){
    const qtd = parseInt(row.qtd) || 0
    const total = parseFloat((row.amount||'').toString().replace(',','.')) || 0
    const parcelValue = qtd>0 ? total / qtd : total
    if(!row.parcelado || qtd <= 0) return {installmentsOccurred: 0, parcelValue, sumUntil: total}
    const start = parseDate(row.start)
    if(!start) return {installmentsOccurred:0, parcelValue, sumUntil:0}
    const up = upToDate || new Date()
    let occurred = 0
    for(let k=0;k<qtd;k++){
      const instDate = addMonths(start, k)
      if(instDate <= up) occurred++
    }
    const sumUntil = occurred * parcelValue
    return {installmentsOccurred: occurred, parcelValue, sumUntil}
  }

  function updateTotals(){
    const upTo = filterDate || (filterEnd.value ? parseDate(filterEnd.value) : null) || new Date()
    let totalAll = 0
    let totalParcelsUntil = 0
    let totalRemainingBeforeObtained = 0

    tbody.querySelectorAll('tr').forEach((tr, idx)=>{
      const row = rows[idx]
      const totalVal = parseFloat((row.amount||'').toString().replace(',','.')) || 0
      totalAll += totalVal
      totalRemainingBeforeObtained += totalVal

      const info = computeRowParcelInfo(row, upTo)
      if(row.parcelado){
        totalParcelsUntil += info.sumUntil
      } else {
        const start = parseDate(row.start)
        if(!start || start <= upTo) totalParcelsUntil += totalVal
      }

      const remainingCell = tr.querySelector('[data-remaining]')
      if(remainingCell) remainingCell.textContent = 'R$ ' + totalVal.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})

      const statusCell = tr.querySelector('[data-status]')
      const end = parseDate(row.end)
      if(end && end < new Date()) statusCell.textContent = 'Vencida'
      else if(row.parcelado) statusCell.textContent = 'Parcelada'
      else statusCell.textContent = 'Ã€ vista'
    })

    const globalObt = parseFloat((document.getElementById('globalObtained').value||'').toString().replace(',','.'))||0
    const finalRemaining = totalRemainingBeforeObtained - globalObt

    totalAllEl.textContent = 'R$ ' + totalAll.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})
    totalParcelsEl.textContent = 'R$ ' + totalParcelsUntil.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})
    document.getElementById('totalStatusCell').textContent = ''

    totalRemainingEl.textContent = 'R$ ' + Math.abs(finalRemaining).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})
    totalRemainingEl.style.color = finalRemaining >= 0 ? 'green' : 'red'

    if(filterDate || filterEnd.value){
      const up = filterDate || (filterEnd.value ? parseDate(filterEnd.value) : null)
      infoFilterEl.textContent = up ? `Somando parcelas atÃ©: ${up.toISOString().slice(0,10)}` : '(sem filtro)'
    } else {
      infoFilterEl.textContent = '(sem filtro)'
    }
  }

  addBtn.onclick = ()=>{ rows.push({item:'', amount:'', parcelado:false, qtd:1, parcelValue:'', start:'', end:''}); render(); }
  clearBtn.onclick = ()=>{ if(!confirm('Limpar todas as linhas?')) return; rows=[{item:'', amount:'', parcelado:false, qtd:1, parcelValue:'', start:'', end:''}]; render(); }

  applyFilterBtn.onclick = ()=>{ if(!filterEnd.value){ alert('Escolha uma data para filtrar atÃ© (campo Filtrar atÃ©).'); return } filterDate = parseDate(filterEnd.value); updateTotals(); }
  clearFilterBtn.onclick = ()=>{ filterDate = null; filterEnd.value=''; updateTotals(); }

  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      const el = document.activeElement
      if(el && (el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA')){
        e.preventDefault()
        addBtn.click()
      }
    }
  })

  render()
  document.getElementById('globalObtained').oninput = updateTotals
  // ðŸ”¹ Salvar automaticamente as informaÃ§Ãµes
function salvarAutomaticamente() {
    const dados = {
        rows,
        filterDate,
        globalObtained: document.getElementById('globalObtained').value,
        filterEnd: filterEnd.value
    };
    localStorage.setItem("controleDividasCasamento", JSON.stringify(dados));
}

// ðŸ”¹ Restaurar ao carregar o site
function restaurarDados() {
    const dadosSalvos = localStorage.getItem("controleDividasCasamento");
    if (dadosSalvos) {
        try {
            const dados = JSON.parse(dadosSalvos);
            rows = dados.rows || rows;
            filterDate = dados.filterDate || null;
            if (dados.globalObtained) document.getElementById('globalObtained').value = dados.globalObtained;
            if (dados.filterEnd) filterEnd.value = dados.filterEnd;
            render();
        } catch(e) {
            console.warn("Erro ao restaurar dados salvos:", e);
        }
    } else {
        render();
    }
}

// ðŸš€ Ativar salvamento automÃ¡tico sem interferir no uso
window.onload = restaurarDados;
document.addEventListener("input", salvarAutomaticamente);
document.addEventListener("blur", salvarAutomaticamente, true);

</script>
</body>
</html>
